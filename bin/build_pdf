#!/usr/bin/env bash

JEKYLL_PORT=${JEKYLL_PORT:-4000}
PDF_PATH=${PDF_PATH:-static/pdf/}

mkdir -p $PDF_PATH
eval "$(cat .env)" &>/dev/null

if ! [ -x "$(command -v wkhtmltopdf)" ]; then
    echo 'wkhtmltopdf not installed'
    if [ "$(uname)" == "Darwin" ]; then
        echo 'Install it with "brew cask install wkhtmltopdf"'
    fi
fi

function create_pdf_local {
    echo Creating pdf with local installed wkhtmltopdf
    wkhtmltopdf --print-media-type http://localhost:$JEKYLL_PORT $PDF_PATH/cv.pdf
}

function create_pdf_docker {
    echo Creating pdf with docker installed wkhtmltopdf
    docker run surnet/alpine-wkhtmltopdf:3.7-0.12.5-small host.docker.internal:$JEKYLL_PORT --print-media-type  - > $PDF_PATH/cv.pdf
}

function create_pdf {
    if [ $DOCKER == 1 ];then
        create_pdf_docker
    else
        create_pdf_local
    fi
}

if [ -z "$(lsof -i :$JEKYLL_PORT)" ];then
    jekyll serve --incremental --port $JEKYLL_PORT &
    sleep 1
    let JEKYLL_PID=echo $!
    create_pdf
    kill $JEKYLL_PID
else
    create_pdf
fi
exit
